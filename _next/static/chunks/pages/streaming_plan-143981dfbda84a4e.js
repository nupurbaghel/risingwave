(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[47],{4248:function(t,r,e){(window.__NEXT_P=window.__NEXT_P||[]).push(["/streaming_plan",function(){return e(1245)}])},1245:function(t,r,e){"use strict";e.r(r),e.d(r,{default:function(){return F}});var n=e(7568),a=e(4051),o=e.n(a),i=e(5893),c=e(2102),l=e(639),u=e(3234),s=e(7026),d=e(1611),f=e(7098),h=e(6486),v=e(9008),p=e.n(v),g=e(1163),x=e(7294),m=e(3812);function y(t){var r=t.mvDependency,e=t.svgWidth,n=t.selectedId,a=t.onSelectedIdChange,o=(0,x.useRef)(),c=(0,x.useState)("0px"),l=c[0],u=c[1],s=(0,x.useCallback)((function(){var t=(0,f.zx)().nodeSize([10,34,5]),e=(0,h.cloneDeep)(r),n=t(e);return{width:n.width,height:n.height,dag:e}}),[r]),v=s();return(0,x.useEffect)((function(){v.width;var t=v.height,r=v.dag,i=o.current,c=d.Ys(i),l=d.ak_,s=d.jvg().curve(l).x((function(t){return t.x+10})).y((function(t){return t.y})),f=function(t){return t.data.id===n},h=c.select(".edges").selectAll(".edge").data(r.links()),p=function(t){return t.attr("d",(function(t){var r=t.points;return s(r)})).attr("fill","none").attr("stroke-width",(function(t){return f(t.source)||f(t.target)?2:1})).attr("stroke",(function(t){return f(t.source)||f(t.target)?m.rS.colors.teal[500]:m.rS.colors.gray[300]}))};h.exit().remove(),h.enter().call((function(t){return t.append("path").attr("class","edge").call(p)})),h.call(p);var g=c.select(".nodes").selectAll(".node").data(r.descendants()),x=function(t){return t.attr("transform",(function(t){var r=t.x,e=t.y;return"translate(".concat(r+10,", ").concat(e,")")})).attr("fill",(function(t){return f(t)?m.rS.colors.teal[500]:m.rS.colors.gray[500]}))};g.exit().remove(),g.enter().call((function(t){return t.append("circle").attr("class","node").attr("r",5).call(x)})),g.call(x);var y=c.select(".labels").selectAll(".label").data(r.descendants()),w=function(t){return t.text((function(t){return t.data.name})).attr("x",e-10).attr("font-family","inherit").attr("text-anchor","end").attr("alignment-baseline","middle").attr("y",(function(t){return t.y})).attr("fill",(function(t){return f(t)?m.rS.colors.black[500]:m.rS.colors.gray[500]})).attr("font-weight","600")};y.exit().remove(),y.enter().call((function(t){return t.append("text").attr("class","label").call(w)})),y.call(w);var k=c.select(".overlays").selectAll(".overlay").data(r.descendants()),S=function(t){return t.attr("x",3).attr("height",24).attr("width",e-6).attr("y",(function(t){return t.y-5-12+2+3})).attr("rx",5).attr("fill",m.rS.colors.gray[500]).attr("opacity",0).style("cursor","pointer")};k.exit().remove(),k.enter().call((function(t){return t.append("rect").attr("class","overlay").call(S).on("mouseover",(function(t,r){d.Ys(this).transition().duration(parseInt(m.rS.transition.duration.normal)).attr("opacity",".10")})).on("mouseout",(function(t,r){d.Ys(this).transition().duration(parseInt(m.rS.transition.duration.normal)).attr("opacity","0")})).on("mousedown",(function(t,r){d.Ys(this).transition().duration(parseInt(m.rS.transition.duration.normal)).attr("opacity",".20")})).on("mouseup",(function(t,r){d.Ys(this).transition().duration(parseInt(m.rS.transition.duration.normal)).attr("opacity",".10")})).on("click",(function(t,r){a&&a(r.data.id)}))})),k.call(S),u("".concat(t,"px"))}),[r,n,e,a,v]),(0,i.jsxs)("svg",{ref:o,width:"".concat(e,"px"),height:l,children:[(0,i.jsx)("g",{className:"edges"}),(0,i.jsx)("g",{className:"nodes"}),(0,i.jsx)("g",{className:"labels"}),(0,i.jsx)("g",{className:"overlays"})]})}var w=e(1799),k=e(9534),S=e(603),b=e(4293);function j(t,r){var e=r.dx,n=r.dy,a=d.G_s().nodeSize([n,e])(t);return a.each((function(t){var r;return r=[t.y,t.x],t.x=r[0],t.y=r[1],r})),a.each((function(t){return t.x=-t.x})),a}function I(t,r){var e=r.margin,n=e.top,a=e.bottom,o=e.left,i=e.right,c=1/0,l=-c,u=1/0,s=-u;return t.each((function(t){return l=t.x>l?t.x:l})),t.each((function(t){return c=t.x<c?t.x:c})),t.each((function(t){return s=t.y>s?t.y:s})),t.each((function(t){return u=t.y<u?t.y:u})),c-=o,l+=i,u-=n,s+=a,t.each((function(t){return t.x=t.x-c})),t.each((function(t){return t.y=t.y-u})),{width:l-c,height:s-u}}var D=12;function _(t){var r=t.planNodeDependencies,e=t.fragmentDependency,n=t.selectedFragmentId,a=(0,x.useRef)(),o=(0,x.useCallback)((function(){var t=(0,h.cloneDeep)(r),n=(0,h.cloneDeep)(e),a=new Map,o=!0,i=!1,c=void 0;try{for(var l,u=t[Symbol.iterator]();!(o=(l=u.next()).done);o=!0){var s=(0,S.Z)(l.value,2),d=s[0],f=j(s[1],{dx:72,dy:48}),v=I(f,{margin:{left:60,right:60,top:48,bottom:60}}),p=v.width,g=v.height;a.set(d,{layoutRoot:f,width:p,height:g})}}catch(P){i=!0,c=P}finally{try{o||null==u.return||u.return()}finally{if(i)throw c}}var x=(0,b.bK)(n.map((function(t){t.width,t.height;var r=t.id,e=(0,k.Z)(t,["width","height","id"]),n=a.get(r),o=n.width,i=n.height;return(0,w.Z)({width:o,height:i,id:r},e)})),60,60),m=new Map;x.forEach((function(t){var r=t.id,e=t.x,n=t.y;m.set(r,{x:e,y:n})}));var y=[],D=!0,_=!1,C=void 0;try{for(var N,E=a[Symbol.iterator]();!(D=(N=E.next()).done);D=!0){var A=(0,S.Z)(N.value,2),F=A[0],R=A[1],Y=m.get(F),M=Y.x,W=Y.y;y.push((0,w.Z)({id:F,x:M,y:W},R))}}catch(P){_=!0,C=P}finally{try{D||null==E.return||E.return()}finally{if(_)throw C}}var Z=0,q=0;y.forEach((function(t){var r=t.x,e=t.y,n=t.width,a=t.height;q=Math.max(q,e+a+50),Z=Math.max(Z,r+n)}));var z=(0,b.o)(x);return{layoutResult:y,fragmentLayout:x,svgWidth:Z,svgHeight:q,links:z}}),[r,e]),c=o(),l=c.svgWidth,u=c.svgHeight,s=c.links,f=c.fragmentLayout,v=c.layoutResult;return(0,x.useEffect)((function(){if(v){var t=a.current,r=d.Ys(t),e=d.h5h().x((function(t){return t.x})).y((function(t){return t.y})),o=function(t){return t===n},i=function(t){t.attr("transform",(function(t){var r=t.x,e=t.y;return"translate(".concat(r,", ").concat(e,")")}));var r=t.select(".actor-text");r.empty()&&(r=t.append("text").attr("class","actor-text")),r.attr("fill","black").text((function(t){var r=t.id;return"Fragment #".concat(r)})).attr("font-family","inherit").attr("text-anchor","end").attr("dy",(function(t){return t.height-12+12})).attr("dx",(function(t){return t.width-12})).attr("fill","black").attr("font-size",12);var n=t.select(".bounding-box");n.empty()&&(n=t.append("rect").attr("class","bounding-box")),n.attr("width",(function(t){return t.width-24})).attr("height",(function(t){return t.height-24})).attr("x",12).attr("y",12).attr("fill","white").attr("stroke-width",(function(t){var r=t.id;return o(r)?3:1})).attr("rx",5).attr("stroke",(function(t){var r=t.id;return o(r)?m.rS.colors.teal[500]:m.rS.colors.gray[500]}));var a=t.select(".links");a.empty()&&(a=t.append("g").attr("class","links"));var i=function(t){return t.attr("d",e)},c=a.selectAll("path").data((function(t){return t.layoutRoot.links()}));c.enter().call((function(t){return t.append("path").attr("fill","none").attr("stroke",m.rS.colors.gray[700]).attr("stroke-width",1.5).call(i),t})),c.call(i),c.exit().remove();var l=t.select(".nodes");l.empty()&&(l=t.append("g").attr("class","nodes"));var u=function(t){t.attr("transform",(function(t){return"translate(".concat(t.x,",").concat(t.y,")")}));var r=t.select("circle");r.empty()&&(r=t.append("circle")),r.attr("fill",m.rS.colors.teal[500]).attr("r",D).style("cursor","pointer");var e=t.select("text");return e.empty()&&(e=t.append("text")),e.attr("fill","black").text((function(t){return t.data.name})).attr("font-family","inherit").attr("text-anchor","middle").attr("dy",21.6).attr("fill","black").attr("font-size",12).attr("transform","rotate(-8)"),t},s=l.selectAll(".actor-node").data((function(t){return t.layoutRoot.descendants()}));s.exit().remove(),s.enter().call((function(t){return t.append("g").attr("class","actor-node").call(u)})),s.call(u)},c=r.select(".actors").selectAll(".actor").data(v);c.enter().call((function(t){return t.append("g").attr("class","actor").call(i)})),c.call(i),c.exit().remove();var l=r.select(".actor-links").selectAll(".actor-link").data(s),u=d.FdL,f=d.jvg().curve(u).x((function(t){return t.x})).y((function(t){return t.y})),h=function(t){return t.attr("d",(function(t){var r=t.points;return f(r)})).attr("fill","none").attr("stroke-width",(function(t){return o(t.source)||o(t.target)?2:1})).attr("stroke",(function(t){return o(t.source)||o(t.target)?m.rS.colors.teal[500]:m.rS.colors.gray[300]}))};l.enter().call((function(t){return t.append("path").attr("class","actor-link").call(h)})),l.call(h),l.exit().remove()}}),[f,v,s,n]),(0,i.jsxs)("svg",{ref:a,width:"".concat(l,"px"),height:"".concat(u,"px"),children:[(0,i.jsx)("g",{className:"actor-links"}),(0,i.jsx)("g",{className:"actors"})]})}var C=e(5330),N=e(221);function E(t){var r=t.actors[0],e=function(t){var r;return{name:(null===(r=t.nodeBody)||void 0===r?void 0:r.$case.toString())||"unknown",children:(t.input||[]).map(e),operatorId:t.operatorId}};return d.bT9({name:r.dispatcher.map((function(t){return"".concat((0,h.toLower)(t.type),"Dispatcher")})).join(",")||"noDispatcher",children:r.nodes?[e(r.nodes)]:[],operatorId:"dispatcher"})}function A(t){var r=(0,x.useState)(),e=r[0],a=r[1],i=(0,c.pm)();return(0,x.useEffect)((function(){var r=function(){var r=(0,n.Z)(o().mark((function r(){var e;return o().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t();case 3:e=r.sent,a(e),r.next=11;break;case 7:r.prev=7,r.t0=r.catch(0),i({title:"Error Occurred",description:r.t0.toString(),status:"error",duration:5e3,isClosable:!0}),console.error(r.t0);case 11:case"end":return r.stop()}}),r,null,[[0,7]])})));return function(){return r.apply(this,arguments)}}();r()}),[i,t]),{response:e}}function F(){var t,r,e,n=A(N.BA).response,a=A(N.jV).response,o=(0,x.useState)(),c=o[0],d=o[1],h=(0,g.useRouter)(),v=(0,x.useCallback)((function(){if(a&&h.query.id){var t=parseInt(h.query.id),r=a.find((function(r){return r.tableId===t}));if(r){var e=function(t){var r=function(r){var a=t.fragments[r],o=new Set,i=!0,c=!1,l=void 0;try{for(var u,s=a.actors[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var d=u.value,f=!0,h=!1,v=void 0;try{for(var p,g=d.upstreamActorId[Symbol.iterator]();!(f=(p=g.next()).done);f=!0){var x=p.value,m=n.get(x);m&&o.add(m)}}catch(y){h=!0,v=y}finally{try{f||null==g.return||g.return()}finally{if(h)throw v}}}}catch(y){c=!0,l=y}finally{try{i||null==s.return||s.return()}finally{if(c)throw l}}e.push({id:a.fragmentId.toString(),name:"Fragment ".concat(a.fragmentId),parentIds:Array.from(o).map((function(t){return t.toString()})),width:0,height:0,order:a.fragmentId})},e=[],n=new Map;for(var a in t.fragments){var o=t.fragments[a],i=!0,c=!1,l=void 0;try{for(var u,s=o.actors[Symbol.iterator]();!(i=(u=s.next()).done);i=!0){var d=u.value;n.set(d.actorId,d.fragmentId)}}catch(h){c=!0,l=h}finally{try{i||null==s.return||s.return()}finally{if(c)throw l}}}for(var f in t.fragments)r(f);return e}(r);return{fragments:r,fragmentDep:e,fragmentDepDag:(0,f.lu)()(e)}}}}),[a,h.query.id]);(0,x.useEffect)((function(){return n&&(h.query.id||n.length>0&&h.replace("?id=".concat(n[0].id))),function(){}}),[h,h.query.id,n]);var m=null===(t=v())||void 0===t?void 0:t.fragmentDep,w=null===(r=v())||void 0===r?void 0:r.fragmentDepDag,k=null===(e=v())||void 0===e?void 0:e.fragments,S=(0,x.useCallback)((function(){var t=null===k||void 0===k?void 0:k.fragments;if(t){var r=new Map;for(var e in t){var n=E(t[e]);r.set(e,n)}return r}}),[null===k||void 0===k?void 0:k.fragments]),b=S(),j=(0,i.jsxs)(l.kC,{p:3,height:"calc(100vh - 20px)",flexDirection:"column",children:[(0,i.jsx)(C.Z,{children:"Streaming Plan"}),(0,i.jsxs)(l.kC,{flexDirection:"row",height:"full",width:"full",children:[(0,i.jsxs)(l.gC,{mr:3,spacing:3,alignItems:"flex-start",width:200,height:"full",children:[(0,i.jsxs)(u.NI,{children:[(0,i.jsx)(u.lX,{children:"Materialized View"}),(0,i.jsx)(s.Ph,{value:h.query.id,onChange:function(t){return h.replace("?id=".concat(t.target.value))},children:n&&n.filter((function(t){return!t.name.startsWith("__")})).map((function(t){return(0,i.jsxs)("option",{value:t.id,children:["(",t.id,") ",t.name]},t.name)}))})]}),(0,i.jsxs)(l.kC,{height:"full",width:"full",flexDirection:"column",children:[(0,i.jsx)(l.xv,{fontWeight:"semibold",children:"Plan"}),w&&(0,i.jsx)(l.xu,{flex:"1",overflowY:"scroll",children:(0,i.jsx)(y,{svgWidth:200,mvDependency:w,onSelectedIdChange:function(t){return d(parseInt(t))},selectedId:null===c||void 0===c?void 0:c.toString()})})]})]}),(0,i.jsxs)(l.xu,{flex:1,height:"full",ml:3,overflowX:"scroll",overflowY:"scroll",children:[(0,i.jsx)(l.xv,{fontWeight:"semibold",children:"Fragment Graph"}),b&&m&&(0,i.jsx)(_,{selectedFragmentId:null===c||void 0===c?void 0:c.toString(),fragmentDependency:m,planNodeDependencies:b})]})]})]});return(0,i.jsxs)(x.Fragment,{children:[(0,i.jsx)(p(),{children:(0,i.jsx)("title",{children:"Streaming Fragments"})}),j]})}}},function(t){t.O(0,[662,474,118,704,282,293,774,888,179],(function(){return r=4248,t(t.s=r);var r}));var r=t.O();_N_E=r}]);